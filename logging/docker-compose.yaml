version: "3.8"

volumes:
    certs:
        driver: local
    elasticsearch-data:
        driver: local
    kibana-data:
        driver: local
    logstash-data:
        driver: local

networks:
    elk-network:
        driver: bridge

services:
    setup:
        build:
            context: setup
            dockerfile: Dockerfile
        image: setup:latest
        container_name: setup
        # restart: always
        networks:
            - elk-network
        volumes:
            - certs:/usr/share/elasticsearch/config/certs
        env_file:
            - .env
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "[ -f config/certs/elasticsearch/elasticsearch.crt ]",
                ]
            interval: 1s
            timeout: 2s
            retries: 120

    elasticsearch:
        depends_on:
            setup:
                condition: service_healthy
        image: docker.elastic.co/elasticsearch/elasticsearch:${ELK_VERSION}
        container_name: elasticsearch
        restart: always
        networks:
            - elk-network
        volumes:
            - certs:/usr/share/elasticsearch/config/certs:ro
            - elasticsearch-data:/usr/share/elasticsearch/data
        env_file:
            - .env
        environment:
            - node.name=es01
            - cluster.name=${CLUSTER_NAME}
            - discovery.type=single-node
            - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
            - bootstrap.memory_lock=true
            - xpack.security.enabled=true
            - xpack.security.http.ssl.enabled=true
            - xpack.security.http.ssl.key=certs/elasticsearch/elasticsearch.key
            - xpack.security.http.ssl.certificate=certs/elasticsearch/elasticsearch.crt
            - xpack.security.http.ssl.certificate_authorities=certs/ca/ca.crt
            - xpack.security.transport.ssl.enabled=true
            - xpack.security.transport.ssl.key=certs/elasticsearch/elasticsearch.key
            - xpack.security.transport.ssl.certificate=certs/elasticsearch/elasticsearch.crt
            - xpack.security.transport.ssl.certificate_authorities=certs/ca/ca.crt
            - xpack.security.transport.ssl.verification_mode=certificate
            - xpack.license.self_generated.type=${LICENSE_TYPE}
        mem_limit: 2g
        ulimits:
            memlock:
                soft: -1
                hard: -1
        healthcheck:
            test: [
                    "CMD-SHELL",
                    "curl -s --cacert config/certs/ca/ca.crt https://localhost:9200 \
                    | grep -q 'missing authentication credentials'",
                ]
            interval: 10s
            timeout: 10s
            retries: 120

    kibana:
        depends_on:
            elasticsearch:
                condition: service_healthy
        image: docker.elastic.co/kibana/kibana:${ELK_VERSION}
        container_name: kibana
        restart: always
        networks:
            - elk-network
        ports:
            - ${KIBANA_PORT}:5601
        env_file:
            - .env
        volumes:
            - certs:/usr/share/kibana/config/certs:ro
            - kibana-data:/usr/share/kibana/data
        environment:
            - SERVERNAME=kibana
            - ELASTICSEARCH_HOSTS=${ELASTIC_HOST}
            - ELASTICSEARCH_USERNAME=${KIBANA_USERNAME}
            - ELASTICSEARCH_PASSWORD=${KIBANA_PASSWORD}
            - ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=config/certs/ca/ca.crt
            - ELASTICSEARCH_SSL_VERIFICATIONMODE=certificate
            - SERVER_SSL_ENABLED=true
            - SERVER_SSL_CERTIFICATE=config/certs/kibana/kibana.crt
            - SERVER_SSL_KEY=config/certs/kibana/kibana.key
        mem_limit: 1g
        healthcheck:
            test: [
                    "CMD-SHELL",
                    "curl -u ${ELASTIC_USERNAME}:${ELASTIC_PASSWORD} \
                    --cacert config/certs/kibana/kibana.crt -I https://localhost:5601/app/home \
                    | grep -q 'HTTP/2 200'",
                ]
            interval: 10s
            timeout: 10s
            retries: 120

    logstash:
        depends_on:
            elasticsearch:
                condition: service_healthy
        image: docker.elastic.co/logstash/logstash:${ELK_VERSION}
        container_name: logstash
        restart: always
        networks:
            - elk-network
        volumes:
            - certs:/usr/share/logstash/config/certs:ro
            - logstash-data:/usr/share/logstash/data
            - ./logstash/conf/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
            - ./nginx/logs/access.log:/usr/share/logstash/data/access.log:ro
        env_file:
            - .env
        environment:
            - NODE_NAME=logstash
            - xpack.monitoring.enabled=false
            - ELASTIC_USERNAME=${ELASTIC_USERNAME}
            - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
            - ELASTIC_HOSTS=${ELASTIC_HOST}
        command: logstash -f /usr/share/logstash/pipeline/logstash.conf
        mem_limit: 1g
